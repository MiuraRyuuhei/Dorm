<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å¯®ãƒã‚¤ãƒ³ãƒˆ & ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ v7.4ï¼ˆãƒ‘ãƒãƒ³ã‚³éŸ³ãƒ»éŸ³ã®ã¿ãƒ¢ãƒ¼ãƒ‰ï¼‰</title>
<style>
:root{--bg:#0b0f14;--panel:#0e1624;--muted:#94a3b8;--text:#e6edf3;--border:#1f2937;--accent:#60a5fa}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,Segoe UI,Helvetica,Arial}
header{position:sticky;top:0;background:#0b0f14cc;padding:14px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}.badge{background:var(--accent);color:#0b0f14;padding:2px 8px;border-radius:999px;font-size:12px}
main{max-width:1180px;margin:18px auto;padding:0 14px;display:grid;grid-template-columns:1fr 460px;gap:14px}
section{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
h2{font-size:15px;margin:2px 0 8px}.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button{border:1px solid var(--border);background:#0b1322;color:var(--text);border-radius:10px;padding:8px 10px}
button{cursor:pointer}
.small{font-size:12px;color:var(--muted)}.mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
.tbl{width:100%;border-collapse:collapse;font-size:14px;border-radius:10px;overflow:hidden}
.tbl th,.tbl td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left}.tbl th{color:var(--muted)}
.tabs{display:flex;gap:6px;margin-bottom:8px}.tabs button{padding:6px 10px}.tabs button.active{background:#0d1b32;border-color:#1e3a8a}
.hidden{display:none}.right{display:flex;justify-content:flex-end;gap:8px}

/* Overlay */
#overlay{position:fixed;inset:0;background:#000c;display:none;align-items:center;justify-content:center;z-index:1000}
#wheelCard{background:#0c1220;border:1px solid var(--border);border-radius:16px;padding:14px;max-width:900px;width:92%}
#canvasWrap{position:relative;display:flex;justify-content:center;align-items:center}
#pointer{position:absolute;top:8px;width:0;height:0;border-left:14px solid transparent;border-right:14px solid transparent;border-bottom:24px solid #ffd166;filter:drop-shadow(0 0 6px #000)}
#wheel{display:block}#fx{position:absolute;top:0;left:0;pointer-events:none}
.controls{display:flex;gap:8px;justify-content:space-between;margin-top:8px;align-items:center}
.legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.legend span{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 6px;border-radius:999px}
.colorDot{width:10px;height:10px;border-radius:50%}

/* ç¢ºå®šãƒ»è±ªè¯æ¼”å‡º */
.rainbowRing{position:absolute;inset:8px;border-radius:50%;pointer-events:none;
  background:conic-gradient(from 0deg,#f00,#ff0,#0f0,#0ff,#00f,#f0f,#f00);
  filter:blur(6px) saturate(140%) brightness(1.2) opacity(.55);animation:spin360 2s linear infinite}
@keyframes spin360{to{transform:rotate(360deg)}}
#cut{position:absolute;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:5}
#cut .stamp{transform:scale(.2) rotate(-12deg);border:5px solid #f87171;color:#fecaca;padding:14px 18px;border-radius:10px;
  font-weight:900;letter-spacing:10px;font-size:52px;opacity:0;text-shadow:0 3px 10px #000a}
.showStamp{animation:stampIn .62s ease-out forwards}
@keyframes stampIn{0%{transform:scale(.2) rotate(-12deg);opacity:0}60%{transform:scale(1.15) rotate(3deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}

/* å½“é¸ãƒ»ã‚ºãƒ¼ãƒ æ¼”å‡º */
#winnerBig{position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none;z-index:6}
#winnerBig .name{font-size:40px;font-weight:900;letter-spacing:4px;padding:12px 16px;border-radius:14px;background:#0b1322cc;border:2px solid #ffd166;
  color:#fff;text-shadow:0 4px 22px #000;transform:scale(.2);filter:drop-shadow(0 0 10px #ffd166)}
.zoomPop{animation:zoomPop .9s cubic-bezier(.2,1.3,.24,1) forwards}
@keyframes zoomPop{0%{transform:scale(.2)}84%{transform:scale(1.15)}100%{transform:scale(1)}}
.shake{animation:shakey 620ms cubic-bezier(.36,.07,.19,.97) 2}
@keyframes shakey{10%,90%{transform:translate3d(-1px,0,0)}20%,80%{transform:translate3d(2px,0,0)}30%,50%,70%{transform:translate3d(-4px,0,0)}40%,60%{transform:translate3d(4px,0,0)}}

/* å¸ä¼šãƒ¢ãƒ¼ãƒ‰ */
.hostFull #wheelCard{max-width:96vw;width:96vw}.hostFull #wheel{width:66vw;height:66vw;max-width:900px;max-height:900px}
</style>
</head>
<body>
<header><h1>å¯®ãƒã‚¤ãƒ³ãƒˆ & ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ <span class="badge">v7.4</span></h1></header>
<main>
  <!-- å·¦ï¼šãƒã‚¹ã‚¿è¡¨ç¤ºï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ãã®ã¾ã¾ï¼‰ -->
  <section>
    <div class="tabs">
      <button class="active" data-tab="people">äºº</button>
      <button data-tab="good">å–„è¡Œ</button>
      <button data-tab="bad">ç½°å‰‡</button>
      <button data-tab="total">åˆè¨ˆãƒã‚¤ãƒ³ãƒˆ</button>
    </div>

    <div id="tab-people">
      <h2>äººï¼ˆID / è¨˜å· / åå‰ï¼‰</h2>
      <table class="tbl" id="peopleTbl"><thead><tr><th style="width:80px">ID</th><th>è¨˜å·</th><th>åå‰</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-good" class="hidden">
      <h2>å–„è¡Œï¼ˆé …ç›® / ç‚¹æ•°ï¼‰</h2>
      <table class="tbl" id="goodTbl"><thead><tr><th style="width:100px">å–„è¡ŒID</th><th>é …ç›®</th><th style="width:80px">ç‚¹æ•°</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-bad" class="hidden">
      <h2>ç½°å‰‡ï¼ˆé …ç›® / ç‚¹æ•°ï¼‰</h2>
      <table class="tbl" id="badTbl"><thead><tr><th style="width:100px">æ‚ªè¡ŒID</th><th>é …ç›®</th><th style="width:80px">ç‚¹æ•°</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="tab-total" class="hidden">
      <h2>åˆè¨ˆãƒã‚¤ãƒ³ãƒˆï¼ˆãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè¨­å®šï¼‰</h2>
      <div class="row">
        <label class="small">åŸºç¤é‡ã¿</label><input id="cfgBase" type="number" step="0.1" value="1"/>
        <label class="small">æœ€å°é‡ã¿</label><input id="cfgMin" type="number" step="0.1" value="0.1"/>
        <label class="small">æ‚ªè¡Œä¿‚æ•°Î±</label><input id="cfgBad" type="number" step="0.1" value="1"/>
        <label class="small">å–„è¡Œä¿‚æ•°Î²</label><input id="cfgGood" type="number" step="0.1" value="0.5"/>
      </div>
      <table class="tbl" id="totalTbl" style="margin-top:8px">
        <thead><tr><th>ID</th><th>è¨˜å·</th><th>åå‰</th><th>å–„è¡Œåˆè¨ˆ</th><th>æ‚ªè¡Œåˆè¨ˆ</th><th>åˆè¨ˆ</th><th>é‡ã¿</th><th>å‰²åˆ</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="right small" style="margin-top:6px">é‡ã¿åˆè¨ˆ: <span class="mono" id="sumW">0</span></div>
    </div>
  </section>

  <!-- å³ï¼šæ“ä½œ -->
  <section>
    <h2>ãƒã‚¤ãƒ³ãƒˆå…¥åŠ›</h2>
    <div class="row">
      <input id="logDate" type="date"/>
      <input id="logPersonId" type="number" placeholder="äººID"/>
      <input id="logSymbol" type="text" placeholder="è¨˜å·"/>
      <select id="logKind"><option value="good">å–„è¡Œ</option><option value="bad">æ‚ªè¡Œ</option></select>
      <input id="logDeedId" type="text" placeholder="å–„è¡ŒID/æ‚ªè¡ŒID (ä¾‹: G001/B003)"/>
      <input id="logPoints" type="number" step="1" placeholder="ç‚¹æ•°(ç©ºã§æ—¢å®š)"/>
      <button onclick="addLog()">è¿½åŠ </button>
    </div>

    <h2 style="margin-top:8px">æŠ½é¸</h2>
    <div class="row">
      <button onclick="openWheel('normal')">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæŠ½é¸</button>
      <button onclick="openWheel('v2')">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ2</button>
      <label class="small"><input type="checkbox" id="soundEnable" checked/> ã‚µã‚¦ãƒ³ãƒ‰</label>
      <!-- â–¼ è¿½åŠ ï¼šã‚µã‚¦ãƒ³ãƒ‰ã®ç¨®é¡ã¨éŸ³ã®ã¿ãƒ¢ãƒ¼ãƒ‰ -->
      <select id="soundMode" title="ã‚µã‚¦ãƒ³ãƒ‰ç¨®é¡">
        <option value="simple" selected>ã‚µã‚¦ãƒ³ãƒ‰: ã‚·ãƒ³ãƒ—ãƒ«</option>
        <option value="pachi">ã‚µã‚¦ãƒ³ãƒ‰: ãƒ‘ãƒãƒ³ã‚³ï¼ˆãã‚…ã„ãƒ¼ã‚“ï¼‰</option>
        <option value="off">ã‚µã‚¦ãƒ³ãƒ‰: ã‚ªãƒ•</option>
      </select>
      <label class="small"><input type="checkbox" id="onlySound"/> æ¼”å‡ºã‚ªãƒ•ï¼ˆéŸ³ã®ã¿ï¼‰</label>
      <button onclick="soundTest()">ã‚µã‚¦ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
      <button onclick="toggleHost()">å¸ä¼šãƒ¢ãƒ¼ãƒ‰</button>
    </div>

    <h2 style="margin-top:8px">ãƒ‡ãƒ¼ã‚¿</h2>
    <div class="row">
      <button onclick="exportJson()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ›¸ãå‡ºã—</button>
      <input type="file" id="importFile" accept=".json" onchange="importJson(event)"/>
      <button onclick="restoreInitial()">åˆæœŸãƒ‡ãƒ¼ã‚¿å¾©å…ƒ</button>
    </div>

    <h2 style="margin-top:8px">ãƒ­ã‚°</h2>
    <div id="logList" class="mono small" style="max-height:260px;overflow:auto;border:1px dashed var(--border);border-radius:8px;padding:8px"></div>
  </section>
</main>

<!-- overlayï¼ˆãƒ›ã‚¤ãƒ¼ãƒ«ï¼‰ -->
<div id="overlay" role="dialog" aria-modal="true">
  <div id="wheelCard">
    <h2 id="wheelTitle" style="margin:0 0 8px">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>
    <div id="canvasWrap">
      <div id="pointer"></div>
      <canvas id="wheel" width="620" height="620"></canvas>
      <canvas id="fx" width="620" height="620"></canvas>
      <div id="cut"><div class="stamp">ç¢ºã€€å®š</div></div>
      <div id="winnerBig"><div class="name">å½“ãŸã‚Šï¼</div></div>
    </div>
    <div id="wheelInfo" class="small" style="margin-top:6px;color:#cbd5e1"></div>
    <div id="legend" class="legend"></div>
    <div class="controls">
      <div class="small" id="preMsg"></div>
      <div>
        <button id="spinBtn" onclick="spinNow()">å›ã™</button>
        <button onclick="closeWheel()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
</div>

<script>
/*** ---------- åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & ãƒ‡ãƒ¼ã‚¿ï¼ˆæ§‹é€ ã¯ãã®ã¾ã¾ï¼‰ ---------- ***/
const $=s=>document.querySelector(s);
const today=()=> new Date().toISOString().slice(0,10);
const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const KEY='dorm-jp-v7'; const LEGACY=['dorm-jp-v6'];

const initial = {
  people: [
    {id:1, sym:'H', name:'åŠ è—¤'},{id:2, sym:'ã²', name:'æ¤å£'},{id:3, sym:'â—', name:'è¦‹å®š'},
    {id:4, sym:'G', name:'å‰ç”°'},{id:5, sym:'r', name:'åŒ—å·'},{id:6, sym:'ï¿¥', name:'é‡‘'},
    {id:7, sym:'K', name:'æ»å±±'},{id:8, sym:'â‡”', name:'ä¸‰æµ¦'},{id:9, sym:'ğŸŒ¸', name:'èŠ±ç”°'},
    {id:10, sym:'4', name:'æœ¬ç”°'},{id:11, sym:'å¤•', name:'ç™½å·'},{id:12, sym:'e', name:'å±±ç”°'},
    {id:13, sym:'ãƒ¡', name:'ç›®é»’'},{id:14, sym:'Y', name:'ä¸­ç”°'},{id:15, sym:'F', name:'å¤å®¶'},
    {id:16, sym:'â€»', name:'é£¯å¡š'},{id:17, sym:'äºº', name:'æ»'},
  ],
  good: [
    {id:"G001", title:"å…±ç”¨ã‚­ãƒƒãƒãƒ³æ¸…æƒï¼ˆã‚·ãƒ³ã‚¯ãƒ»ã‚³ãƒ³ãƒ­ãƒ»åºŠã®æ‹­ãä¸Šã’ï¼‰", pt:2},
    {id:"G002", title:"ãƒˆã‚¤ãƒ¬æƒé™¤ï¼æµ´å®¤æ¸…æƒ", pt:1},
    {id:"G003", title:"ãƒ©ã‚¦ãƒ³ã‚¸ãƒ»å»Šä¸‹ã®ãƒ¢ãƒƒãƒ—æ›ã‘ï¼åŸƒå–ã‚Š", pt:1},
    {id:"G004", title:"ã‚´ãƒŸã®åˆ†åˆ¥ã¨é›†ç©æ‰€ã¸ã®æ¬å‡º", pt:1},
    {id:"G005", title:"å…±æœ‰å†·è”µåº«ã®æ•´ç†ï¼ˆæœŸé™åˆ‡ã‚Œå‡¦åˆ†ï¼‰", pt:1},
    {id:"G006", title:"æ¶ˆè€—å“è£œå……ï¼ˆãƒˆã‚¤ãƒšãƒ»æ´—å‰¤ç­‰ï¼‰", pt:1},
    {id:"G007", title:"è¨­å‚™ä¸å…·åˆã®å ±å‘Šãƒ»ä¸€æ¬¡å¯¾å¿œï¼ˆæ¼æ°´ãƒ»ç ´æãªã©ï¼‰", pt:1},
    {id:"G008", title:"éå¸¸å£ãƒ»é¿é›£çµŒè·¯ã®ç‚¹æ¤œï¼ˆç‰©å“ã®æ’¤å»ï¼‰", pt:1},
    {id:"G009", title:"çœã‚¨ãƒè¡Œå‹•ï¼ˆç…§æ˜ãƒ»ç©ºèª¿ã®æ¶ˆã—å¿˜ã‚Œæ˜¯æ­£ï¼‰", pt:1},
    {id:"G010", title:"ã‚¤ãƒ™ãƒ³ãƒˆé‹å–¶ã®æ‰‹ä¼ã„ï¼ˆè¨­å–¶ãƒ»ç‰‡ä»˜ã‘ï¼‰", pt:1},
    {id:"G011", title:"æ–°å…¥ç”Ÿã‚µãƒãƒ¼ãƒˆï¼ˆæ¡ˆå†…ãƒ»å¼•è¶Šã—è£œåŠ©ï¼‰", pt:1},
    {id:"G012", title:"ä½“èª¿ä¸è‰¯è€…ã®è²·ã„ç‰©ä»£è¡Œ", pt:1},
    {id:"G013", title:"æ¸…æƒç”¨å…·ã®ãƒ¡ãƒ³ãƒ†ï¼ˆæ´—æµ„ãƒ»äº¤æ›ï¼‰", pt:1},
    {id:"G014", title:"å®³è™«å¯¾ç­–ï¼ˆãƒˆãƒ©ãƒƒãƒ—è¨­ç½®ãƒ»ç™ºç”Ÿå ±å‘Šï¼‰", pt:1},
    {id:"G015", title:"ãƒ«ãƒ¼ãƒ«æ²ç¤ºãƒ»å‘¨çŸ¥ã®æ›´æ–°", pt:1},
  ],
  bad: [
    {id:"B001", title:"å½¼å¥³é€£ã‚Œè¾¼ã¿", pt:5},
    {id:"B002", title:"è·ç‰©æ”¾ç½®", pt:2},
    {id:"B003", title:"ãªã‚“ã‹ã‚€ã‹ã¤ã", pt:10},
    {id:"B004", title:"æ‚ªè‡­", pt:3},
    {id:"B005", title:"ç„¡æ–­ã‚²ã‚¹ãƒˆ", pt:2},
  ],
  logs: [],
  config:{base:1,min:0.1,alpha:1,beta:0.5}
};

const state = structuredClone(initial);
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function tryMigrate(){
  for(const k of LEGACY){
    const raw = localStorage.getItem(k); if(!raw) continue;
    try{
      const old = JSON.parse(raw);
      if(old.people?.length) state.people = old.people;
      if(old.good?.length)   state.good   = old.good;
      if(old.bad?.length)    state.bad    = old.bad;
      if(old.logs?.length){
        state.logs = old.logs.map(l=>{
          const p = (typeof l.points==='number')? l.points : (l.val??0);
          const d = l.date || (l.ts? l.ts.slice(0,10) : today());
          return {date:d, personId:l.personId||l.pid, kind:l.kind||(p>=0?'good':'bad'), deedId:l.deedId||'', points:p};
        });
      }
      if(old.config) Object.assign(state.config, old.config);
      return true;
    }catch{}
  }
  return false;
}
function loadEnsure(){
  const raw = localStorage.getItem(KEY);
  if(raw){ try{ Object.assign(state, JSON.parse(raw)); }catch{} }
  const migrated = (!state.people?.length||!state.good?.length||!state.bad?.length) && tryMigrate();
  if(!state.people?.length) state.people=structuredClone(initial.people);
  if(!state.good?.length)   state.good  =structuredClone(initial.good);
  if(!state.bad?.length)    state.bad   =structuredClone(initial.bad);
  if(!state.logs) state.logs=[];
  if(!state.config) state.config=structuredClone(initial.config);
  save();
  return migrated?'migrated':'loaded';
}

/*** ---------- é›†è¨ˆï¼ˆãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯å¤‰æ›´ãªã—ï¼‰ ---------- ***/
function totals(){
  const t=new Map(); state.people.forEach(p=>t.set(p.id,{g:0,b:0}));
  for(const l of state.logs){
    if(!t.has(l.personId)) continue;
    if((l.points??0)>=0) t.get(l.personId).g += (l.points??0);
    else t.get(l.personId).b += -(l.points??0);
  }
  const cfg=state.config;
  const rows = state.people.map(p=>{
    const o=t.get(p.id)||{g:0,b:0}; const total=o.g-o.b;
    const w=Math.max(cfg.min, cfg.base + cfg.alpha*o.b - cfg.beta*o.g);
    return {id:p.id, sym:p.sym, name:p.name, g:o.g, b:o.b, total, w};
  });
  const sumW = rows.reduce((s,x)=>s+x.w,0);
  rows.forEach(r=>r.prob = sumW? r.w/sumW : 0);
  return {rows,sumW};
}

/*** ---------- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---------- ***/
function renderPeople(){ const tb=$('#peopleTbl tbody'); tb.innerHTML='';
  state.people.forEach(p=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${p.id}</td><td>${esc(p.sym)}</td><td>${esc(p.name)}</td>`; tb.appendChild(tr); });
}
function renderGood(){ const tb=$('#goodTbl tbody'); tb.innerHTML='';
  state.good.forEach(g=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${g.id}</td><td>${esc(g.title)}</td><td class="mono">${g.pt}</td>`; tb.appendChild(tr); });
}
function renderBad(){ const tb=$('#badTbl tbody'); tb.innerHTML='';
  state.bad.forEach(b=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${b.id}</td><td>${esc(b.title)}</td><td class="mono">${b.pt}</td>`; tb.appendChild(tr); });
}
function renderTotal(){
  $('#cfgBase').value=state.config.base; $('#cfgMin').value=state.config.min;
  $('#cfgBad').value=state.config.alpha; $('#cfgGood').value=state.config.beta;
  const {rows,sumW}=totals(); $('#sumW').textContent=sumW.toFixed(2);
  const tb=$('#totalTbl tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${r.id}</td><td>${esc(r.sym)}</td><td>${esc(r.name)}</td>
      <td class="mono">${r.g}</td><td class="mono">${r.b}</td><td class="mono">${r.total}</td>
      <td class="mono">${r.w.toFixed(2)}</td><td class="mono">${(r.prob*100).toFixed(2)}%</td>`;
    tb.appendChild(tr);
  });
  $('#logList').textContent = state.logs.map(l=>{
    const p = state.people.find(x=>x.id===l.personId);
    const sign = (l.points??0)>=0? '+' : '';
    return `[${l.date}] ${p?.name||'?'} ${sign}${l.points??0} (${l.kind}/${l.deedId||''})`;
  }).join('\n') || '(ãƒ­ã‚°ãªã—)';
}
function renderAll(){ renderPeople(); renderGood(); renderBad(); renderTotal(); }

/*** ---------- å…¥åŠ› ---------- ***/
function resolvePersonId(idInput, symInput){
  const id=Number(idInput||0); if(id) return id;
  const sym=(symInput||'').trim(); if(!sym) return null;
  const p=state.people.find(x=>String(x.sym)===sym);
  return p?.id ?? null;
}
function addLog(){
  const date=$('#logDate').value || today();
  const personId=resolvePersonId($('#logPersonId').value,$('#logSymbol').value);
  const kind=$('#logKind').value;
  const deedId=($('#logDeedId').value||'').trim().toUpperCase();
  const override=$('#logPoints').value? Number($('#logPoints').value) : null;
  if(!personId || !kind) return alert('äººID/è¨˜å· ã¨ ç¨®åˆ¥ ã‚’å…¥ã‚Œã¦ãã ã•ã„');
  let base=0;
  if(kind==='good'){ const m=state.good.find(x=>x.id===deedId); base=m? m.pt : 1; }
  else { const m=state.bad.find(x=>x.id===deedId); base=m? m.pt : 1; }
  const p = (kind==='good'? +1 : -1) * (override ?? base);
  state.logs.unshift({date,personId,kind,deedId,points:p});
  save(); renderAll();
}

/*** ---------- ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼ˆ3ç§’æ¸›é€Ÿãƒ»ç¢ºå®šæ¼”å‡ºã‚ã‚Šï¼‰ ---------- ***/
let wheelSegments=[], wheelRotation=0, spinning=false;
let mode='normal';
function segColor(i){ const h=(i*137.5)%360; return `hsl(${h}deg 70% 55%)`; }

function openWheel(m){
  mode=m||'normal';
  // è¨­å®šåæ˜ 
  state.config.base=Number($('#cfgBase').value||0);
  state.config.min =Number($('#cfgMin').value||0);
  state.config.alpha=Number($('#cfgBad').value||0);
  state.config.beta =Number($('#cfgGood').value||0);

  const {rows,sumW}=totals();
  if(sumW<=0) return alert('é‡ã¿åˆè¨ˆãŒ0ã§ã™ï¼ˆãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰');

  let start=0; wheelSegments = rows.map((r,i)=>{ const ang=2*Math.PI*(r.w/sumW);
    const seg={...r,start:start,end:start+ang,color:segColor(i)}; start+=ang; return seg; });
  wheelRotation=0; drawWheel();

  // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰
  const L=$('#legend'); L.innerHTML='';
  wheelSegments.forEach(s=>{ const el=document.createElement('span');
    el.innerHTML=`<span class="colorDot" style="background:${s.color}"></span>${esc(s.name)} (${(s.prob*100).toFixed(1)}%)`; L.appendChild(el);
  });

  $('#wheelTitle').textContent = (mode==='v2')?'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ2':'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ';
  $('#wheelInfo').textContent  = 'ã€Œå›ã™ã€ã‚’æŠ¼ã™ã¨æŠ½é¸ã—ã¾ã™ï¼ˆ3ç§’ãƒ»æ¸›é€Ÿåœæ­¢ï¼‰';
  $('#preMsg').textContent     = '';
  hideCut(); $('#overlay').style.display='flex';
}

function closeWheel(){ if(spinning) return; $('#overlay').style.display='none'; }

function drawWheel(){
  const cvs=$('#wheel'), ctx=cvs.getContext('2d'); const W=cvs.width,H=cvs.height, cx=W/2, cy=H/2, r=Math.min(W,H)/2-10;
  ctx.clearRect(0,0,W,H);
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(wheelRotation);
  wheelSegments.forEach(s=>{
    ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,s.start,s.end); ctx.closePath();
    ctx.fillStyle=s.color; ctx.fill(); ctx.strokeStyle="#0b0f14"; ctx.lineWidth=2; ctx.stroke();
    const mid=(s.start+s.end)/2; ctx.save(); ctx.rotate(mid); ctx.textAlign="right"; ctx.fillStyle="#0b0f14"; ctx.font="bold 12px ui-sans-serif";
    const label=s.name.length>8?s.name.slice(0,8)+'â€¦':s.name; ctx.fillText(label+" "+Math.round(s.prob*100)+"%", r-8, 4); ctx.restore();
  });
  ctx.beginPath(); ctx.arc(0,0,48,0,Math.PI*2); ctx.fillStyle="#0b1322"; ctx.fill(); ctx.strokeStyle="#1f2937"; ctx.stroke();
  ctx.restore();
}

function angleToIndex(rot){
  let a=(-Math.PI/2)-rot; a=(a%(2*Math.PI)+2*Math.PI)%(2*Math.PI);
  for(let i=0;i<wheelSegments.length;i++){const s=wheelSegments[i]; if(a>=s.start&&a<s.end) return i;}
  return wheelSegments.length-1;
}
function centerOf(seg){ return (seg.start+seg.end)/2; }
function targetRotationForCenter(center, current, minSpins=3){
  const base = -Math.PI/2 - center;
  const k = Math.ceil( (current - base) / (2*Math.PI) + minSpins );
  return base + k*2*Math.PI;
}

function spinNow(){
  if(spinning) return;
  $('#spinBtn').disabled = true;

  if(soundOn()) startSpinSfx(3000);

  if(mode==='v2'){
    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ2ï¼šé€”ä¸­ã§ç¢ºå®šã‚«ãƒƒãƒˆã‚¤ãƒ³â†’å¤å®¶ã«å¼·åˆ¶ç€åœ°
    spinWithCutInToFurue();
  }else{
    // é€šå¸¸ï¼šé‡ã¿ã«æ¯”ä¾‹ã—ã¦å½“é¸ã€3ç§’ã§æ¸›é€Ÿåœæ­¢
    const winner = pickByWeight();
    const center = centerOf(winner);
    const final  = targetRotationForCenter(center, wheelRotation, 5);
    animateSpin(wheelRotation, final, 3000, easeOutCubic, ()=>{
      finishSpin(winner);
    });
  }
}

function pickByWeight(){
  let total=0; const lens=wheelSegments.map(s=>s.end-s.start); total=lens.reduce((a,b)=>a+b,0);
  let r=Math.random()*total, w=null; for(const s of wheelSegments){ r-= (s.end-s.start); if(r<=0){ w=s; break; } }
  return w || wheelSegments.at(-1);
}

function spinWithCutInToFurue(){
  const phase1=1200, phase2=1800;
  const intermediate = wheelRotation + 2.5*Math.PI + Math.random()*Math.PI;
  animateSpin(wheelRotation, intermediate, phase1, easeOutCubic, ()=>{
    // ã‚«ãƒƒãƒˆã‚¤ãƒ³ï¼šç¢ºå®šâ†’å¤æ±Ÿã¸
    if(!onlySound()) showCut(true);
    if(soundOn()){
      if(soundMode()==='pachi') playKyuiSequence(); else playCutInSfx();
    }
    const furue = wheelSegments.find(s=> String(s.sym)==='F' || /å¤å®¶/.test(s.name) ) || wheelSegments[0];
    const center = centerOf(furue);
    const final  = targetRotationForCenter(center, wheelRotation, 4);
    animateSpin(wheelRotation, final, phase2, easeOutCubic, ()=>{
      finishSpin(furue);
    });
  });
}

function animateSpin(from,to,dur,ease,done){
  const start=performance.now(); spinning=true;
  let lastIdx = angleToIndex(from);
  function frame(t){
    const p=Math.min(1,(t-start)/dur); const e=ease(p);
    wheelRotation = from + (to-from)*e;
    drawWheel();
    const idx = angleToIndex(wheelRotation);
    if(idx!==lastIdx && soundOn()) tick();
    lastIdx = idx;
    if(p<1) requestAnimationFrame(frame); else { spinning=false; done&&done(); }
  }
  requestAnimationFrame(frame);
}
const easeOutCubic = p => 1 - Math.pow(1-p,3);

/*** ---------- æ¼”å‡º/éŸ³ ---------- ***/
function onlySound(){ return $('#onlySound').checked; }
function soundMode(){ return $('#soundMode').value; }
function soundOn(){ return $('#soundEnable').checked && soundMode()!=='off'; }

function showCut(withRing){
  const cut=$('#cut'); cut.style.display='flex';
  const st=cut.querySelector('.stamp'); st.classList.remove('showStamp'); void st.offsetWidth; st.classList.add('showStamp');
  if(withRing){ const wrap=$('#canvasWrap'); wrap.querySelectorAll('.rainbowRing').forEach(n=>n.remove());
    const ring=document.createElement('div'); ring.className='rainbowRing'; wrap.appendChild(ring); }
}
function hideCut(){ $('#cut').style.display='none'; $('#canvasWrap').querySelectorAll('.rainbowRing').forEach(n=>n.remove()); }

function finishSpin(win){
  hideCut();
  if(!onlySound()){
    $('#wheelCard').classList.add('shake'); setTimeout(()=>$('#wheelCard').classList.remove('shake'),1200);
    const wb=$('#winnerBig'); wb.style.display='flex'; const label=win.name + (win.sym?`ï¼ˆ${win.sym}ï¼‰`:'');
    wb.querySelector('.name').textContent = (mode==='v2'?'ç¢ºå®šï¼ ':'å½“ãŸã‚Šï¼ ') + label;
    const nm=wb.querySelector('.name'); nm.classList.remove('zoomPop'); void nm.offsetWidth; nm.classList.add('zoomPop');
    confetti(); spotlight(win);
  }
  if(soundOn()){ stopSpinSfx(); setTimeout(()=>playJackpot(), 80); }
  setTimeout(()=>{ if(!onlySound()) $('#winnerBig').style.display='none'; $('#spinBtn').disabled=false; }, 3200);
}

function spotlight(win){
  const fx=$('#fx'), ctx=fx.getContext('2d'); const W=fx.width,H=fx.height,cx=W/2,cy=H/2,r=Math.min(W,H)/2-10;
  const ang=(win.end-win.start); const t0=performance.now();
  function draw(t){ const p=Math.min(1,(t-t0)/1200);
    ctx.clearRect(0,0,W,H); ctx.save(); ctx.translate(cx,cy); ctx.globalCompositeOperation='lighter';
    const grd=ctx.createRadialGradient(0,0,r*.3,0,0,r); grd.addColorStop(0,'rgba(255,255,200,.14)'); grd.addColorStop(1,'rgba(255,255,160,0)');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,-ang/2,+ang/2); ctx.closePath(); ctx.fill(); ctx.restore();
    if(p<1) requestAnimationFrame(draw);
  } requestAnimationFrame(draw);
}

function confetti(){
  if(onlySound()) return;
  const fx=$('#fx'), ctx=fx.getContext('2d'); const W=fx.width,H=fx.height;
  const parts=Array.from({length:240},()=>({x:W/2,y:40,vx:(Math.random()-.5)*6,vy:Math.random()*-1,g:.22+Math.random()*.12,s:4+Math.random()*3,r:Math.random()*6,vr:(Math.random()-.5)*.2,c:`hsl(${Math.random()*360}deg 80% 60%)`,life:160}));
  let t=0; const timer=setInterval(()=>{t++; ctx.clearRect(0,0,W,H);
    parts.forEach(p=>{p.vy+=p.g;p.x+=p.vx;p.y+=p.vy;p.r+=p.vr;p.life--; ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.r);ctx.fillStyle=p.c;ctx.fillRect(-p.s/2,-p.s/2,p.s,p.s);ctx.restore();});
    if(t>200){clearInterval(timer);ctx.clearRect(0,0,W,H);} },16);
}

/*** ---------- WebAudioï¼ˆãƒ‘ãƒãƒ³ã‚³é¢¨ + æ—¢å­˜éŸ³ï¼‰ ---------- ***/
let AC=null; const ac=()=>AC||(AC=new (window.AudioContext||window.webkitAudioContext)());

// å›è»¢ä¸­ã®ãƒ¯ãƒ¼ãƒ¼ãƒ³ï¼ˆãƒ¢ãƒ¼ãƒ‰åˆ¥ï¼‰
let spinNodes=null;
function startSpinSfx(ms){
  stopSpinSfx();
  if(soundMode()==='pachi'){ return startPachiSpin(ms); }
  // simple
  const ctx=ac();
  const g=ctx.createGain(); g.gain.value=0.12; g.connect(ctx.destination);
  const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=900; bp.Q.value=0.6; bp.connect(g);
  const trem=ctx.createOscillator(); const tremGain=ctx.createGain(); trem.frequency.value=8; tremGain.gain.value=0.35; trem.connect(tremGain.gain); trem.start();
  const o1=ctx.createOscillator(), o2=ctx.createOscillator(), o3=ctx.createOscillator();
  [o1,o2,o3].forEach(o=>{o.type='sawtooth'; o.connect(tremGain);}); tremGain.connect(bp);
  const now=ctx.currentTime;
  o1.frequency.setValueAtTime(520,now); o1.frequency.exponentialRampToValueAtTime(160, now+ms/1000);
  o2.frequency.setValueAtTime(740,now); o2.frequency.exponentialRampToValueAtTime(220, now+ms/1000);
  o3.frequency.setValueAtTime(980,now); o3.frequency.exponentialRampToValueAtTime(320, now+ms/1000);
  [o1,o2,o3].forEach(o=>o.start());
  spinNodes={o1,o2,o3,g,bp,trem,tremGain};
}
function startPachiSpin(ms){
  const ctx=ac();
  const g=ctx.createGain(); g.gain.value=0.12; g.connect(ctx.destination);
  const bp=ctx.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=1200; bp.Q.value=1.2; bp.connect(g);
  // white noise
  const buf=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
  const data=buf.getChannelData(0); for(let i=0;i<data.length;i++) data[i]=Math.random()*2-1;
  const noise=ctx.createBufferSource(); noise.buffer=buf; noise.loop=true; noise.connect(bp); noise.start();
  // motor hum
  const o=ctx.createOscillator(), vibr=ctx.createOscillator(), vg=ctx.createGain(); o.type='sawtooth';
  vibr.frequency.value=7; vg.gain.value=25; vibr.connect(vg); vg.connect(o.frequency);
  o.connect(bp); o.frequency.setValueAtTime(400,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(180, ctx.currentTime+ms/1000);
  o.start();
  spinNodes={noise,o,bp,g,vibr,vg};
}
function stopSpinSfx(){
  if(!spinNodes) return;
  const ctx=ac();
  try{
    Object.values(spinNodes).forEach(n=>{
      if(n instanceof OscillatorNode){ n.stop(ctx.currentTime+0.08); }
      if(n instanceof AudioBufferSourceNode){ n.stop(ctx.currentTime+0.08); }
      if(n instanceof GainNode){ n.gain && n.gain.setTargetAtTime(0, ctx.currentTime, 0.06); }
    });
  }catch{}
  spinNodes=null;
}

// ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé€šéã®ãƒã‚¯éŸ³
function tick(){ const ctx=ac(); const o=ctx.createOscillator(), g=ctx.createGain();
  o.type='square'; o.frequency.setValueAtTime(1200,ctx.currentTime);
  g.gain.setValueAtTime(.06,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+.06);
  o.connect(g).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+.07);
}

// ã‚«ãƒƒãƒˆã‚¤ãƒ³SEï¼ˆæ—¢å­˜ã‚·ãƒ³ãƒ—ãƒ«ï¼‰
function playCutInSfx(){
  const ctx=ac(); const o=ctx.createOscillator(), g=ctx.createGain(); const f=ctx.createBiquadFilter();
  o.type='triangle'; f.type='lowpass'; f.frequency.value=4000; o.connect(f).connect(g).connect(ctx.destination);
  const now=ctx.currentTime; g.gain.value=0.0001; g.gain.exponentialRampToValueAtTime(0.25, now+0.05);
  o.frequency.setValueAtTime(220, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.35);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.6);
  o.start(); o.stop(now+0.6);
}

// â˜…ãƒ‘ãƒãƒ³ã‚³ã€Œãã‚…ã„ãã‚…ã„ãã‚…ã„ãƒ¼ãƒ¼ã‚“ã€ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
function playKyuiSequence(){
  const ctx=ac();
  const master=ctx.createGain(); master.gain.value=0.22; master.connect(ctx.destination);

  function kyui(t0, dur, f0, f1){
    // 2ç™ºã®ãƒªãƒ¼ãƒ‰ + ãƒã‚¤ã‚ºã®ç…Œã‚ã
    const o=ctx.createOscillator(), g=ctx.createGain(), lfo=ctx.createOscillator(), lfg=ctx.createGain();
    o.type='triangle'; lfo.frequency.value=8; lfg.gain.value=20; lfo.connect(lfg); lfg.connect(o.frequency);
    const filt=ctx.createBiquadFilter(); filt.type='bandpass'; filt.frequency.value=2500; filt.Q.value=3.0;
    o.connect(filt).connect(g).connect(master);
    g.gain.setValueAtTime(0.0001, t0); g.gain.exponentialRampToValueAtTime(0.28, t0+0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, t0+dur);

    o.frequency.setValueAtTime(f0, t0);
    o.frequency.exponentialRampToValueAtTime(f1, t0+dur*0.85);

    // ãã‚‰ãã‚‰ãƒã‚¤ã‚º
    const nb=ctx.createBuffer(1, ctx.sampleRate*dur, ctx.sampleRate);
    const arr=nb.getChannelData(0); for(let i=0;i<arr.length;i++) arr[i]=(Math.random()*2-1)*0.4;
    const n=ctx.createBufferSource(); n.buffer=nb; const nfil=ctx.createBiquadFilter(); nfil.type='highpass'; nfil.frequency.value=1800;
    const ng=ctx.createGain(); ng.gain.value=0.1; n.connect(nfil).connect(ng).connect(master); n.start(t0); n.stop(t0+dur);

    o.start(t0); o.stop(t0+dur);
    lfo.start(t0); lfo.stop(t0+dur);
  }

  const t=ctx.currentTime;
  kyui(t+0.00, 0.28, 600, 1600);   // ãã‚…ã„
  kyui(t+0.32, 0.28, 650, 1700);   // ãã‚…ã„
  kyui(t+0.64, 0.65, 700, 3200);   // ãã‚…ã„ãƒ¼ãƒ¼ã‚“ï¼ˆé•·ã‚ï¼‰
}

// å½“ãŸã‚Šãƒ•ã‚¡ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ¬ï¼ˆè»½ããƒ‘ãƒãƒ³ã‚³å¯„ã‚Šï¼‰
function playJackpot(){
  const ctx=ac();
  const notes=[659,784,988,784,988,1175,1319]; // E5 G5 B5 G5 B5 D6 E6
  const g=ctx.createGain(); g.gain.value=0.0001; g.connect(ctx.destination);
  const f=ctx.createBiquadFilter(); f.type='lowpass'; f.frequency.value=4800; f.Q.value=0.8; f.connect(g);

  let t=ctx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.22, t+0.03);

  for(let i=0;i<notes.length;i++){
    const o=ctx.createOscillator(); o.type='square'; o.frequency.value=notes[i];
    const og=ctx.createGain(); og.gain.value=0.14; o.connect(f); o.start(t+i*0.12); o.stop(t+i*0.12+0.22);
  }
  // ãƒ‰ãƒ‰ãƒ‰ãƒ³ï¼ˆã‚­ãƒƒã‚¯é¢¨ï¼‰
  for(let k=0;k<3;k++){
    const b=ctx.createOscillator(), bg=ctx.createGain(); b.type='sine'; b.frequency.setValueAtTime(140, t+0.05+k*0.18);
    bg.gain.setValueAtTime(0.24, t+0.05+k*0.18); bg.gain.exponentialRampToValueAtTime(0.0001, t+0.2+k*0.18);
    b.connect(bg).connect(ctx.destination); b.start(t+0.05+k*0.18); b.stop(t+0.22+k*0.18);
  }
  setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.2); }, 1000);
}

/*** ---------- UIé›‘å¤š ---------- ***/
document.querySelectorAll('.tabs button').forEach(b=>{
  b.addEventListener('click',()=>{document.querySelectorAll('.tabs button').forEach(x=>x.classList.remove('active'));b.classList.add('active');
    ['people','good','bad','total'].forEach(k=>document.getElementById('tab-'+k).classList.add('hidden'));
    document.getElementById('tab-'+b.dataset.tab).classList.remove('hidden');});
});
function toggleHost(){ document.body.classList.toggle('hostFull'); }
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeWheel(); });

// ã‚µã‚¦ãƒ³ãƒ‰ã ã‘é³´ã‚‰ã—ã¦ç¢ºèª
function soundTest(){
  if(!soundOn()){ alert('ã‚µã‚¦ãƒ³ãƒ‰ãŒã‚ªãƒ•ã§ã™ã€‚ãƒã‚§ãƒƒã‚¯ã‚„ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
  if(soundMode()==='pachi'){ playKyuiSequence(); } else { playCutInSfx(); }
}

/*** ---------- èµ·å‹• ---------- ***/
document.addEventListener('DOMContentLoaded', ()=>{
  $('#logDate').value = today();
  loadEnsure(); // æ—§ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«ã€Œå¤æ±Ÿ/ãµã‚‹ãˆã€ãŒæ®‹ã£ã¦ã„ãŸã‚‰ä¸€åº¦ã ã‘ç½®æ›
(function(){
  const p = state.people.find(x => x.id===15 && (x.name==='å¤æ±Ÿ' || x.sym==='ãµã‚‹ãˆ'));
  if (p) { p.name = 'å¤å®¶'; p.sym = 'F'; save(); }
})();
renderAll();
});
</script>
</body>
</html>
